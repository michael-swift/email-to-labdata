# Nanodrop Processor - Development Workflow
# Usage: make <target>

.PHONY: help dev-test prod-deploy accuracy-check logs live-test debug-last tail-logs

# Default target
help:
	@echo "ğŸ§¬ Nanodrop Processor - Available Commands:"
	@echo ""
	@echo "  ğŸ“§ Quick Testing:"
	@echo "    make dev-test      - Deploy to dev + send test email + check results"
	@echo "    make live-test     - Interactive testing loop"
	@echo "    make test-suite    - Test all instrument types"
	@echo ""
	@echo "  ğŸš€ Deployment:"
	@echo "    make prod-deploy   - Deploy to production (with safety checks)"
	@echo "    make dev-deploy    - Deploy to development only"
	@echo ""
	@echo "  ğŸ“Š Analysis:"
	@echo "    make accuracy-check - Check latest extraction accuracy"
	@echo "    make debug-last     - Download & analyze last processed request"
	@echo "    make monitor        - Show system health and metrics"
	@echo ""
	@echo "  ğŸ“‹ Logs:"
	@echo "    make logs          - Show recent logs from both environments"
	@echo "    make tail-logs     - Live log streaming"
	@echo "    make dev-logs      - Show dev environment logs only"
	@echo "    make prod-logs     - Show prod environment logs only"
	@echo ""
	@echo "  ğŸ§¹ Maintenance:"
	@echo "    make clean         - Clean up temporary files"
	@echo "    make status        - Show git status and AWS resources"

# Quick development testing workflow
dev-test:
	@echo "ğŸ§ª Starting dev testing workflow..."
	@echo "1ï¸âƒ£  Deploying to development environment..."
	./deploy/deploy_lambda_env.sh dev
	@echo "2ï¸âƒ£  Sending test email..."
	sleep 10
	python scripts/send_test_email.py --dev
	@echo "3ï¸âƒ£  Waiting for processing (60 seconds)..."
	sleep 60
	@echo "4ï¸âƒ£  Checking results..."
	-python scripts/check_logs.py --dev --last-run
	@echo "âœ… Dev test complete!"

# Production deployment with safety checks
prod-deploy:
	@echo "ğŸš€ Production deployment with safety checks..."
	@echo "âš ï¸  WARNING: This will deploy to PRODUCTION!"
	@read -p "Continue? (y/N) " confirm && [ "$$confirm" = "y" ] || exit 1
	@echo "1ï¸âƒ£  Running dev tests first..."
	make dev-test
	@echo "2ï¸âƒ£  Dev tests passed. Deploying to production..."
	./deploy/deploy_lambda_env.sh prod
	@echo "âœ… Production deployment complete!"

# Development deploy only
dev-deploy:
	@echo "ğŸ§ª Deploying to development environment..."
	./deploy/deploy_lambda_env.sh dev

# Check accuracy of latest extractions
accuracy-check:
	@echo "ğŸ“Š Checking extraction accuracy..."
	python scripts/download_latest_data.py
	python scripts/accuracy_checker.py
	@echo "âœ… Accuracy check complete!"

# Download and analyze last processed request
debug-last:
	@echo "ğŸ” Downloading latest processed request..."
	python scripts/download_latest_data.py --latest
	python scripts/accuracy_checker.py
	python scripts/analyze_request.py
	@echo "âœ… Debug analysis complete!"

# Interactive testing loop
live-test:
	@echo "ğŸ”„ Starting interactive testing loop..."
	python scripts/live_test.py

# Test all instrument types
test-suite:
	@echo "ğŸ§ª Running comprehensive test suite..."
	python scripts/test_email_pipeline.py --env dev
	@echo "âœ… Test suite complete!"

# Show recent logs from both environments
logs:
	@echo "ğŸ“‹ Recent logs from both environments:"
	@echo ""
	@echo "ğŸ§ª DEVELOPMENT LOGS:"
	python scripts/check_logs.py --dev --recent
	@echo ""
	@echo "ğŸš€ PRODUCTION LOGS:"  
	python scripts/check_logs.py --prod --recent

# Live log streaming
tail-logs:
	@echo "ğŸ“¡ Streaming live logs (Ctrl+C to stop)..."
	python scripts/tail_logs.py

# Development logs only
dev-logs:
	@echo "ğŸ“‹ Development environment logs:"
	python scripts/check_logs.py --dev --recent

# Production logs only  
prod-logs:
	@echo "ğŸ“‹ Production environment logs:"
	python scripts/check_logs.py --prod --recent

# System monitoring
monitor:
	@echo "ğŸ“Š System health and metrics:"
	python scripts/monitor.py

# Clean up temporary files
clean:
	@echo "ğŸ§¹ Cleaning up temporary files..."
	rm -f *.json *.csv *.tmp
	find . -name "__pycache__" -type d -exec rm -rf {} + 2>/dev/null || true
	find . -name "*.pyc" -delete 2>/dev/null || true
	find . -name ".DS_Store" -delete 2>/dev/null || true
	@echo "âœ… Cleanup complete!"

# Show system status
status:
	@echo "ğŸ“Š System Status:"
	@echo ""
	@echo "ğŸ“ Git Status:"
	git status --short
	@echo ""
	@echo "â˜ï¸  AWS Lambda Functions:"
	aws lambda list-functions --query 'Functions[?starts_with(FunctionName, `nanodrop`)].FunctionName' --output table
	@echo ""
	@echo "ğŸ“§ SES Rules:"
	aws ses describe-active-receipt-rule-set --query 'Rules[*].[Name,Recipients[0]]' --output table